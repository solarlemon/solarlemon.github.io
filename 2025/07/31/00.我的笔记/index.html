

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head><!-- hexo injector head_begin start --><link rel="stylesheet" href="/css/my-avatar.css"><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#547b59">
  <meta name="author" content="Solar">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 Nacos1.1 注册中心  在每个微服务中导入 web 依赖：  1234&lt;dependency&gt;      &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;      &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;  &lt;&#x2F;dependen">
<meta property="og:type" content="article">
<meta property="og:title" content="尚硅谷七小时学完SpringCloud">
<meta property="og:url" content="http://example.com/2025/07/31/00.%E6%88%91%E7%9A%84%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 Nacos1.1 注册中心  在每个微服务中导入 web 依赖：  1234&lt;dependency&gt;      &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;      &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;  &lt;&#x2F;dependen">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002194.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002195.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002196.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002197.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002198.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002199.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002200.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002201.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002202.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002204.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002205.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002206.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002207.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002208.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002209.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002210.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002211.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002212.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002213.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002214.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002215.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002216.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002217.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002218.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002219.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002220.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002221.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002222.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002223.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002224.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002225.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002226.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002227.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002228.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002229.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002230.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002231.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002232.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002233.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002234.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002235.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002236.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002237.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002238.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002239.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002240.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002241.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002242.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002243.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002244.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002245.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002246.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002247.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002248.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002249.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002250.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002251.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002252.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002253.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002254.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002255.png">
<meta property="og:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002256.png">
<meta property="article:published_time" content="2025-07-31T02:35:00.000Z">
<meta property="article:modified_time" content="2025-07-31T02:35:00.121Z">
<meta property="article:author" content="Solar">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002194.png">
  
  
  
  <title>尚硅谷七小时学完SpringCloud - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/scrollAnimation.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Solar</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default_top_img.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">尚硅谷七小时学完SpringCloud</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-31 10:35" pubdate>
          July 31, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.1k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          43 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">尚硅谷七小时学完SpringCloud</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-Nacos"><a href="#1-Nacos" class="headerlink" title="1 Nacos"></a>1 Nacos</h2><h3 id="1-1-注册中心"><a href="#1-1-注册中心" class="headerlink" title="1.1 注册中心"></a>1.1 注册中心</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002194.png" srcset="/img/loading.gif" lazyload alt="|800|1000"></p>
<ul>
<li>在每个微服务中导入 web 依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>在公共服务中导入 nacos 依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--服务发现 启动注册中心nacos--&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>
<ul>
<li>在 order 微服务中新建一个 SpringBoot 启动项<br><code>services/service-order/src/main/java/com/example/order/OrderMainApplication.java </code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.order;  <br>  <br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;  <br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;  <br>  <br><span class="hljs-meta">@SpringBootApplication</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderMainApplication</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        SpringApplication.run(OrderMainApplication.class, args);  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>编写对应配置文件<br><code>services/service-order/src/main/resources/application.properties</code></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.application.name</span>=<span class="hljs-string">service-order   # 应用/服务名</span><br><span class="hljs-attr">server.port</span>=<span class="hljs-string">8000  </span><br>  <br><span class="hljs-attr">spring.cloud.nacos.server-addr</span>=<span class="hljs-string">127.0.0.1:8848</span><br></code></pre></td></tr></table></figure>
<ul>
<li>按照同样的方法启动多个服务。<br>启动后即可在 nacos 中查看到多个服务：<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002195.png" srcset="/img/loading.gif" lazyload alt="|825|1000"></li>
</ul>
<h3 id="1-2-服务发现"><a href="#1-2-服务发现" class="headerlink" title="1.2 服务发现"></a>1.2 服务发现</h3><blockquote>
<p> 后续底层代码自动实现</p>
</blockquote>
<ul>
<li>开启服务发现功能<br>  在微服务项目中使用注解 <code>@EnableDiscoveryClient</code> 开启服务发现功能。（默认开启）</li>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiscoveryTest</span> &#123;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    DiscoveryClient  discoveryClient;  <br>    <span class="hljs-meta">@Test</span>  <br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDiscovery</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">for</span>(String serviceName : discoveryClient.getServices())&#123;  <br>            System.out.println(serviceName);  <br>            <span class="hljs-comment">//获取ip地址和端口  </span><br>            discoveryClient.getInstances(serviceName).forEach(instance -&gt; &#123;  <br>                System.out.println(instance.getServiceId() + <span class="hljs-string">&quot;:&quot;</span> + instance.getUri());  <br>            &#125;);        <br>        &#125;    <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-远程调用"><a href="#1-3-远程调用" class="headerlink" title="1.3 远程调用"></a>1.3 远程调用</h3><h4 id="1-3-1-基本流程"><a href="#1-3-1-基本流程" class="headerlink" title="1.3.1 基本流程"></a>1.3.1 基本流程</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002196.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<h4 id="1-3-2-下单场景"><a href="#1-3-2-下单场景" class="headerlink" title="1.3.2 下单场景"></a>1.3.2 下单场景</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002197.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<ul>
<li>先使用基本的 SpringBoot 技术搭建出各个 API。<blockquote>
<p>[!note] 由于微服务把各个 bean 都分到不同的 service 中，所以需要一个 model 将所有 bean 放入一个模块中。所以在 services 的 pom.xml 中引入 model 的依赖。</p>
</blockquote>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>在 OrderServiceImpl 中的 createOrder 函数中创建商品订单<br>发送请求 <code>http://localhost:8000/create?userId=2&amp;productId=100</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>  <br>RestTemplate restTemplate;<br><br><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">getProductFromRemote</span><span class="hljs-params">(Long productId)</span> &#123;  <br>    <span class="hljs-comment">// 1.获取商品服务所在的所有机器的IP+port  </span><br>    List&lt;ServiceInstance&gt; instanceList = discoveryClient.getInstances(<span class="hljs-string">&quot;service-product&quot;</span>);  <br>    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">serviceInstance</span> <span class="hljs-operator">=</span> instanceList.get(<span class="hljs-number">0</span>);  <br>    <span class="hljs-comment">// url地址  </span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> serviceInstance.getUri().toString() + <span class="hljs-string">&quot;/product/&quot;</span> + productId;  <br>    log.info(<span class="hljs-string">&quot;url:&#123;&#125;&quot;</span>, url);  <span class="hljs-comment">// url:http://192.168.1.100:9000/product/100</span><br>    <span class="hljs-comment">//2. 给远程发送请求，返回的json结果转换为Product对象  </span><br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>当商品服务器宕机一个时，其他服务器顶上，但是目前面临一个问题，只能固定向某一个未宕机的商品服务器发送请求，马上由<font color="#ff0000">负载均衡</font>来解决。</p>
<p>其中 <code>RestTemplate</code>:<br><code>services/service-order/src/main/java/com/example/order/config/OrderServiceConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceConfig</span> &#123;  <br>    <span class="hljs-comment">// 因为是线程安全的，只有一个对象，所以可以定义为单例  </span><br>    <span class="hljs-meta">@Bean</span>  <br>    <span class="hljs-keyword">public</span> RestTemplate  <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>
<h4 id="1-3-3-负载均衡"><a href="#1-3-3-负载均衡" class="headerlink" title="1.3.3 负载均衡"></a>1.3.3 负载均衡</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002198.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>修改成负载均衡：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span> <span class="hljs-comment">//导入依赖spring-cloud-starter-loadbalancer  </span><br>LoadBalancerClient loadBalancerClient;<br><br><br><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">getProductFromRemoteWithLoadBalance</span><span class="hljs-params">(Long productId)</span> &#123;  <br>    <span class="hljs-comment">// 1.获取商品服务所在的所以机器的IP+port  </span><br>    ServiceInstance choose=loadBalancerClient.choose(<span class="hljs-string">&quot;service-product&quot;</span>);  <br>    <span class="hljs-comment">// url地址  </span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> choose.getUri().toString() + <span class="hljs-string">&quot;/product/&quot;</span> + productId;  <br>    log.info(<span class="hljs-string">&quot;url:&#123;&#125;&quot;</span>, url);  <br>    <span class="hljs-comment">//2. 给远程发送请求，返回的json结果转换为Product对象  </span><br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>基于注解的负载均衡：<br>在 OrderServiceConfig 的 RestTemplate 中添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>  <br><span class="hljs-meta">@LoadBalanced</span> <span class="hljs-comment">//注解的负载均衡  </span><br><span class="hljs-keyword">public</span> RestTemplate  <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();  <br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 基于注解的负载均衡  </span><br><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">getProductFromRemoteWithLoadBalanceAnnotation</span><span class="hljs-params">(Long productId)</span> &#123;  <br>    String url=<span class="hljs-string">&quot;http://service-product/product/&quot;</span>+productId;  <br>    <span class="hljs-comment">//2. 给远程发送请求:service-product会被动态替换  </span><br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);  <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-3-4-面试题"><a href="#1-3-4-面试题" class="headerlink" title="1.3.4 面试题"></a>1.3.4 面试题</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002199.png" srcset="/img/loading.gif" lazyload alt="|750|1000"><br>调用过：会在<font color="#ff0000">实例缓存</font>会保存实例信息，可以从中拿到微服务地址&#x2F;名字，可以通过；<br>没调用过：必须从注册中心获取微服务访问地址，不能通过。</p>
<h3 id="1-4-配置中心"><a href="#1-4-配置中心" class="headerlink" title="1.4 配置中心"></a>1.4 配置中心</h3><p>统一管理所以微服务配置，不停机配置。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002200.png" srcset="/img/loading.gif" lazyload alt="|700|1000"></p>
<h4 id="1-4-1-基本使用"><a href="#1-4-1-基本使用" class="headerlink" title="1.4.1 基本使用"></a>1.4.1 基本使用</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002201.png" srcset="/img/loading.gif" lazyload alt="|825|1000"></p>
<ul>
<li>各个微服务的父项目中引入依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--配置中心--&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>导入配置<br><code>services/service-order/src/main/resources/application.properties</code></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.config.import</span>=<span class="hljs-string">nacos:service-order.properties</span><br></code></pre></td></tr></table></figure>
<ul>
<li>在 nacos 服务页面创建 data-id</li>
<li>即可获取对应值<br>在 OrderController 中获取</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RefreshScope</span> <span class="hljs-comment">//配置中心自动刷新</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;...&#125;<br><br><br><span class="hljs-meta">@Value(&quot;$&#123;order.timeout&#125;&quot;)</span>  <br>String orderTimeout;  <br><span class="hljs-meta">@Value(&quot;$&#123;order.auto-confirm&#125;&quot;)</span>  <br>String orderAutoConfig;<br></code></pre></td></tr></table></figure>
<ul>
<li>存在问题，配置多了需要很多@Value，可以写到一个 properties 类<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002202.png" srcset="/img/loading.gif" lazyload alt="|650|1000"><br><code>services/service-order/src/main/java/com/example/order/properties/OrderProperties.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>  <br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;order&quot;)</span> <span class="hljs-comment">//无需添加自动刷新注解  </span><br><span class="hljs-meta">@Component</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProperties</span> &#123;  <br>  <br>    <span class="hljs-comment">//变量名要一一对应，短横线自动转换为驼峰命名  </span><br>    String timeout;  <br>    String autoConfirm;  <br>&#125;<br>...<br><span class="hljs-meta">@Autowired</span>  <br>OrderProperties orderProperties;<br></code></pre></td></tr></table></figure>
<h4 id="1-4-2-监听配置变化"><a href="#1-4-2-监听配置变化" class="headerlink" title="1.4.2 监听配置变化"></a>1.4.2 监听配置变化</h4><p>在项目启动时监听配置<br><code>services/service-order/src/main/java/com/example/order/OrderMainApplication.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>ApplicationRunner <span class="hljs-title function_">applicationRunner</span><span class="hljs-params">(NacosConfigManager nacosConfigManager)</span>&#123;<br>	<span class="hljs-keyword">return</span>  args -&gt; &#123;<br>		<span class="hljs-type">ConfigService</span> <span class="hljs-variable">configService</span> <span class="hljs-operator">=</span> nacosConfigManager.getConfigService();<br>		configService.addListener(<span class="hljs-string">&quot;service-order.properties&quot;</span>,<br>				<span class="hljs-string">&quot;DEFAULT_GROUP&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener</span>() &#123;<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getExecutor</span><span class="hljs-params">()</span> &#123;<br>						<span class="hljs-keyword">return</span> Executors.newFixedThreadPool(<span class="hljs-number">4</span>);<br>					&#125;<br><br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveConfigInfo</span><span class="hljs-params">(String configInfo)</span> &#123;<br>						System.out.println(<span class="hljs-string">&quot;变化的配置信息：&quot;</span>+configInfo);<br>						System.out.println(<span class="hljs-string">&quot;邮件通知...&quot;</span>);<br>					&#125;<br>				&#125;);<br>		System.out.println(<span class="hljs-string">&quot;=========&quot;</span>);<br>	&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="1-4-3-面试题"><a href="#1-4-3-面试题" class="headerlink" title="1.4.3 面试题"></a>1.4.3 面试题</h4><p>nacos 中的数据集（配置中心）和 application.properties 有相同的配置项，哪个生效?<br>引入了配置中心可以统一管理，所以外部导入的配置生效。</p>
<blockquote>
<p>[!important] 后导入优先+外部有限</p>
</blockquote>
<h4 id="1-4-4-数据隔离"><a href="#1-4-4-数据隔离" class="headerlink" title="1.4.4 数据隔离"></a>1.4.4 数据隔离</h4><p>需求描述<br>• 项目有多套环境：dev，test，prod<br>• 每个微服务，同一种配置，在每套环境的值都不一样。<br>• 如：database. properties • 如：common. properties • 项目可以通过切换环境，加载本环境的配置<br>难点<br>• 区分多套环境<br>• 区分多种微服务<br>• 区分多种配置<br>• 按需加载配置<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002204.png" srcset="/img/loading.gif" lazyload alt="|900|1000"><br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002205.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<h4 id="1-4-5-总结"><a href="#1-4-5-总结" class="headerlink" title="1.4.5 总结"></a>1.4.5 总结</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002206.png" srcset="/img/loading.gif" lazyload alt="|925|1000"></p>
<h2 id="2-OpenFeign"><a href="#2-OpenFeign" class="headerlink" title="2 OpenFeign"></a>2 OpenFeign</h2><p>通过注解实现<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002207.png" srcset="/img/loading.gif" lazyload alt="|800|1000"></p>
<h3 id="2-1-远程调用"><a href="#2-1-远程调用" class="headerlink" title="2.1 远程调用"></a>2.1 远程调用</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002208.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<ul>
<li>安装依赖</li>
<li>FeignClient 发送请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;service-product&quot;)</span> <span class="hljs-comment">//feign远程调用客户端  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;  <br>  <br>    <span class="hljs-comment">//mvc注解的两套使用逻辑  </span><br>    <span class="hljs-comment">//1.标注在controller上，表示接收这样的请求  </span><br>    <span class="hljs-comment">//2.标注在FeignClient上，表示接收这样的请求  </span><br>    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span>  <br>    Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>; <span class="hljs-comment">//自动根据服务名进行负载均衡  </span><br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>在 controller 启用 feiclient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients</span> <span class="hljs-comment">//启用feign远程调用  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>在主启动类添加 @EnableFeignClients</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.example.order.feign&quot;)</span><br></code></pre></td></tr></table></figure>
<ul>
<li>实现<br>在 service 实现类中发起请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>  <br>ProductFeignClient productFeignClient;<br><br><span class="hljs-comment">// Product product = getProductFromRemoteWithLoadBalanceAnnotation(productId);  </span><br><br><span class="hljs-comment">// 使用feign完成远程调用  </span><br><span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productFeignClient.getProductById(productId);<br></code></pre></td></tr></table></figure>

<ul>
<li>远程调用第三方 API</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;weather-client&quot;, url = &quot;http://aliv18.data.moji.com&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WeatherFeignClient</span> &#123;  <br>    <span class="hljs-meta">@PostMapping(&quot;/whapi/json/alicityweather/condition&quot;)</span>  <br>    String <span class="hljs-title function_">getWeather</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader(&quot;Authorization&quot;)</span> String authorization,  </span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(&quot;token&quot;)</span> String token,  </span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(&quot;cityId&quot;)</span> String cityId)</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-2-小技巧-面试题"><a href="#2-2-小技巧-面试题" class="headerlink" title="2.2 小技巧&amp;面试题"></a>2.2 小技巧&amp;面试题</h3><ul>
<li>如何编写好OpenFeign声明式的远程调用接口<ul>
<li>业务API：直接复制对方Controller签名即可</li>
<li>第三方API：根据接口文档确定请求如何发</li>
</ul>
</li>
<li>面试题：客户端负载均衡与服务端负载均衡区别<ul>
<li><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002209.png" srcset="/img/loading.gif" lazyload alt="|725|1000"></li>
</ul>
</li>
</ul>
<h3 id="2-3-日志"><a href="#2-3-日志" class="headerlink" title="2.3 日志"></a>2.3 日志</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002210.png" srcset="/img/loading.gif" lazyload alt="|750|1000"></p>
<ul>
<li>配置文件中添加：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span>  <br>  <span class="hljs-attr">level:</span>  <br>    <span class="hljs-attr">com.example.order.feign:</span> <span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure>
<ul>
<li>配置类中添加：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>  <br>Logger.Level  <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">return</span> Logger.Level.FULL;  <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-4-超时控制"><a href="#2-4-超时控制" class="headerlink" title="2.4 超时控制"></a>2.4 超时控制</h3><ul>
<li><p>分析情况<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002211.png" srcset="/img/loading.gif" lazyload alt="|850|1000"></p>
</li>
<li><p>具体流程<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002212.png" srcset="/img/loading.gif" lazyload alt="|800|1000"></p>
</li>
<li><p>添加配置<br>在 <code>services/service-order/src/main/resources/application.yaml</code> 中添加</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">profiles:</span>  <br>    <span class="hljs-attr">active:</span> <span class="hljs-string">prod</span> <span class="hljs-comment"># 环境标识  </span><br>    <span class="hljs-attr">include:</span> <span class="hljs-string">feign</span> <span class="hljs-comment"># 引入application-feign配置</span><br></code></pre></td></tr></table></figure>
<p><code>services/service-order/src/main/resources/application-feign.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">cloud:</span>  <br>    <span class="hljs-attr">openfeign:</span>  <br>      <span class="hljs-attr">client:</span>  <br>        <span class="hljs-attr">config:</span>  <br>          <span class="hljs-comment"># 所以服务的默认配置</span><br>          <span class="hljs-attr">default:</span>  <br>            <span class="hljs-attr">logger-level:</span> <span class="hljs-string">full</span>  <br>            <span class="hljs-attr">connect-timeout:</span> <span class="hljs-number">1000</span>  <br>            <span class="hljs-attr">read-timeout:</span> <span class="hljs-number">2000</span>  <br>          <span class="hljs-comment"># 指定服务名的配置  </span><br>          <span class="hljs-attr">service-product:</span>  <br>            <span class="hljs-attr">logger-level:</span> <span class="hljs-string">full</span>  <br>            <span class="hljs-attr">connect-timeout:</span> <span class="hljs-number">3000</span>  <br>            <span class="hljs-attr">read-timeout:</span> <span class="hljs-number">5000</span><br></code></pre></td></tr></table></figure>
<ul>
<li>重试机制<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002213.png" srcset="/img/loading.gif" lazyload alt="|750|1000"></li>
</ul>
<p>在配置类中添加设置 <code>services/service-order/src/main/java/com/example/order/config/OrderServiceConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>  <br>Retryer <span class="hljs-title function_">retryer</span><span class="hljs-params">()</span>&#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Retryer</span>.Default();  <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-5-拦截器"><a href="#2-5-拦截器" class="headerlink" title="2.5 拦截器"></a>2.5 拦截器</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002214.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<ul>
<li>请求拦截器<br>把数据放到请求头以共享数据：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span> <span class="hljs-comment">//自动扫码容器中的拦截器  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XTokenRequestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestInterceptor</span> &#123;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;XTokenRequestInterceptor...&quot;</span>);  <br>        <span class="hljs-comment">//设置请求头  </span><br>        requestTemplate.header(<span class="hljs-string">&quot;X-Token&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<p><code>services/service-product/src/main/java/com/example/product/controller/ProductController.java</code> 中获取到数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span>  <br><span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long productId,  </span><br><span class="hljs-params">                          HttpServletRequest request)</span> &#123;  <br>    System.out.println(<span class="hljs-string">&quot;getProduct: &quot;</span> + productId);  <br>    System.out.println(<span class="hljs-string">&quot;X-Token: &quot;</span> + request.getHeader(<span class="hljs-string">&quot;X-Token&quot;</span>));  <br>    <span class="hljs-keyword">return</span> productService.getProductById(productId);  <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-6-Fallback-兜底返回"><a href="#2-6-Fallback-兜底返回" class="headerlink" title="2.6 Fallback-兜底返回"></a>2.6 Fallback-兜底返回</h3><p>拿到兜底数据…<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002215.png" srcset="/img/loading.gif" lazyload alt="|800|1000"></p>
<ul>
<li>配置 sentinel 依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>启用 sentinel<br><code>services/service-order/src/main/resources/application-feign.yaml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span>  <br>  <span class="hljs-attr">sentinel:</span>  <br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<ul>
<li>选择要 fallbak 的 FeignClient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;service-product&quot;,fallback = ProductFeignClientFallback.class)</span> <span class="hljs-comment">//feign远程调用客户端  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;  <br>  <br>    <span class="hljs-comment">//mvc注解的两套使用逻辑  </span><br>    <span class="hljs-comment">//1.标注在controller上，表示接收这样的请求  </span><br>    <span class="hljs-comment">//2.标注在FeignClient上，表示接收这样的请求  </span><br>    <span class="hljs-meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span>  <br>    Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>; <span class="hljs-comment">//自动根据服务名进行负载均衡  </span><br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>编写对应的 <code>ProductFeignClientFallback</code><br><code>services/service-order/src/main/java/com/example/order/feign/fallback/ProductFeignClientFallback.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFeignClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;  <br>  <br>    <span class="hljs-comment">// 调用ProductFeignClient失败时被调用  </span><br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;调用远程服务失败，兜底回调&quot;</span>);  <br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();  <br>        product.setId(<span class="hljs-number">0L</span>);  <br>        product.setPrice(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0&quot;</span>));  <br>        product.setProductName(<span class="hljs-string">&quot;未知商品&quot;</span>);  <br>        product.setNum(<span class="hljs-number">0</span>);  <br>  <br>        <span class="hljs-keyword">return</span> product;  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-7-总结"><a href="#2-7-总结" class="headerlink" title="2.7 总结"></a>2.7 总结</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002216.png" srcset="/img/loading.gif" lazyload alt="|729|1000"></p>
<h2 id="3-Sentinel"><a href="#3-Sentinel" class="headerlink" title="3 Sentinel"></a>3 Sentinel</h2><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Spring Cloud Alibaba Sentinel 以流量为切入点，从流量控制、流量路由、熔断降级、系统自适应过载保护、热点流量防护等多个维度保护服务的稳定性。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002217.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<h3 id="3-1-架构原理"><a href="#3-1-架构原理" class="headerlink" title="3.1 架构原理"></a>3.1 架构原理</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002218.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<h3 id="3-2-资源和规则"><a href="#3-2-资源和规则" class="headerlink" title="3.2 资源和规则"></a>3.2 资源和规则</h3><p> 定义资源：<br> • 主流框架自动适配（Web Servlet、Dubbo、Spring Cloud、gRPC、Spring WebFlux、Reactor）；所有 Web 接口均为资源<br> • 编程式：SphU API<br> • 声明式：@SentinelResource<br> 定义规则：<br> • 流量控制（FlowRule）<br> • 熔断降级（DegradeRule）<br> • 系统保护（SystemRule）<br> • 来源访问控制（AuthorityRule）<br> • 热点参数（ParamFlowRule）<br> <img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002219.png" srcset="/img/loading.gif" lazyload alt="|449|1000"></p>
<h3 id="3-3-基本使用"><a href="#3-3-基本使用" class="headerlink" title="3.3 基本使用"></a>3.3 基本使用</h3><ul>
<li>每个微服务配置依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span> <br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>启动控制台</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar sentinel.jar<br></code></pre></td></tr></table></figure>
<p>登录 locolhost: 8080, 用户名和密码都是 sentinel。</p>
<ul>
<li>配置连接</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>	<span class="hljs-attr">cloud:</span><br>		<span class="hljs-attr">sentinel:</span>  <br>  			<span class="hljs-attr">transport:</span>  <br>    			<span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>  <br>  			<span class="hljs-attr">eager:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 启动时加载sentinel</span><br></code></pre></td></tr></table></figure>
<h3 id="3-4-异常处理"><a href="#3-4-异常处理" class="headerlink" title="3.4 异常处理"></a>3.4 异常处理</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002220.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002221.png" srcset="/img/loading.gif" lazyload alt="|1075|1000"></p>
<h4 id="3-4-1-⾃定义-BlockExceptionHandler"><a href="#3-4-1-⾃定义-BlockExceptionHandler" class="headerlink" title="3.4.1 ⾃定义 BlockExceptionHandler"></a>3.4.1 ⾃定义 BlockExceptionHandler</h4><p>对 controller <code>/create</code> 添加流控规则。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002222.png" srcset="/img/loading.gif" lazyload alt="|950|1000"><br>自定义一个异常处理 <code>com/example/order/exception/MyBlockException.java</code>，其中 R 也是自定义的返回数据类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span> <span class="hljs-comment">//放到容器中即可生效  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBlockException</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlockExceptionHandler</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse,  </span><br><span class="hljs-params">                       String resourceName, BlockException e)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        httpServletResponse.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);  <br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> httpServletResponse.getWriter();  <br>        <span class="hljs-type">R</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> R.error(<span class="hljs-number">500</span>, resourceName + <span class="hljs-string">&quot; 被Sentinel限制了，原因：&quot;</span> + e.getClass());  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(error); <span class="hljs-comment">//写为json数据  </span><br>        writer.write(json);  <br>        writer.flush();  <br>        writer.close();  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<p>触发异常后返回自定义的返回数据。</p>
<h4 id="3-4-2-blockHandler"><a href="#3-4-2-blockHandler" class="headerlink" title="3.4.2 blockHandler"></a>3.4.2 blockHandler</h4><p><font color="#ff0000">对 createOrder 添加流控规则</font>。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002223.png" srcset="/img/loading.gif" lazyload alt="|1000|1000"><br>@SentinelResource标注在非Controller 层。标注在 servicImpl实现层 <code>OrderServiceImpl</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SentinelResource(value = &quot;createOrder&quot;, blockHandler = &quot;createOrderFallback&quot;)</span><span class="hljs-comment">//设置自己处理异常  </span><br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, Long productId)</span> &#123;  <br>	..。<br>&#125;<br><br><span class="hljs-comment">//兜底回调，注意相同的方法名  </span><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrderFallback</span><span class="hljs-params">(Long userId, Long productId, BlockException e)</span> &#123;  <br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();  <br>    order.setId(<span class="hljs-number">0L</span>);  <br>    order.setTotalAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0</span>));  <br>    order.setUserId(userId);  <br>    order.setNickName(<span class="hljs-string">&quot;None&quot;</span>);  <br>    order.setAddress(<span class="hljs-string">&quot;&quot;</span>);  <br>    <span class="hljs-keyword">return</span> order;<span class="hljs-comment">//兜底数据  </span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-3-OpenFeign-兜底回调"><a href="#3-4-3-OpenFeign-兜底回调" class="headerlink" title="3.4.3 OpenFeign-兜底回调"></a>3.4.3 OpenFeign-兜底回调</h4><p>对远程调用添加流控规则。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002224.png" srcset="/img/loading.gif" lazyload alt="|1000|1000"><br>在 2.6 节所述。</p>
<h3 id="3-5-规则-流量控制"><a href="#3-5-规则-流量控制" class="headerlink" title="3.5 规则 - 流量控制"></a>3.5 规则 - 流量控制</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002225.png" srcset="/img/loading.gif" lazyload alt="|775|1000"><br>流控设置的面板：<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002226.png" srcset="/img/loading.gif" lazyload alt="|1000"></p>
<h4 id="3-5-1-阈值类型"><a href="#3-5-1-阈值类型" class="headerlink" title="3.5.1 阈值类型"></a>3.5.1 阈值类型</h4><p>QPS：统计每秒请求数<br>并发线程数：统计并发线程数</p>
<h4 id="3-5-2-流控模式"><a href="#3-5-2-流控模式" class="headerlink" title="3.5.2 流控模式"></a>3.5.2 流控模式</h4><ul>
<li>直接策略<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002227.png" srcset="/img/loading.gif" lazyload alt="|1000"></li>
<li>链路策略<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002228.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>对于普通的创建订单资源 A 不做限制，但是对于秒杀资源 C 做限制。<br>配置设置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sentinel:</span>  <br>  <span class="hljs-attr">web-context-unify:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 关闭上下文统一，分离请求链路</span><br></code></pre></td></tr></table></figure>
<p>添加 controller 请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/secKill&quot;)</span>  <br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">secKill</span><span class="hljs-params">(<span class="hljs-meta">@PathParam(&quot;userId&quot;)</span> Long userId,  </span><br><span class="hljs-params">                     <span class="hljs-meta">@PathParam(&quot;productId&quot;)</span> Long productId)</span> &#123;  <br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(userId, productId);  <br>    order.setId(Long.MAX_VALUE);  <br>    <span class="hljs-keyword">return</span> order;  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>对 createOrder 资源的两条链路：<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002229.png" srcset="/img/loading.gif" lazyload alt="|1050|1000"><br>新增链路规则：<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002230.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>仅对于 <code>/secKill</code> 这条链路限制。</p>
<ul>
<li>关联策略<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002231.png" srcset="/img/loading.gif" lazyload alt="|1000"></li>
</ul>
<p><font color="#ff0000">读写相关，写入量大时，优先写。</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/writeDB&quot;)</span>  <br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">writeDB</span><span class="hljs-params">()</span>&#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;writeDB.....&quot;</span>;  <br>&#125;  <br>  <br><span class="hljs-meta">@GetMapping(&quot;/readDB&quot;)</span>  <br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">readDB</span><span class="hljs-params">()</span>&#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;readDB.....&quot;</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002232.png" srcset="/img/loading.gif" lazyload alt="|455|1000"></p>
<h4 id="3-5-3-流控效果"><a href="#3-5-3-流控效果" class="headerlink" title="3.5.3 流控效果"></a>3.5.3 流控效果</h4><ul>
<li>快速失败<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002233.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>超过数量的请求直接失败。注意：除了快速失败，其他流控效果的流控模式（链路策略等）会直接失效。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002234.png" srcset="/img/loading.gif" lazyload alt="|505|1000"></li>
<li>Warm Up<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002235.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>让系统逐步增加可接收的请求。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002236.png" srcset="/img/loading.gif" lazyload alt="|530|1000"></li>
<li>匀速排队<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002237.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>最大等待时间 timeout。</li>
</ul>
<h3 id="3-6-规则-熔断降级"><a href="#3-6-规则-熔断降级" class="headerlink" title="3.6 规则 - 熔断降级"></a>3.6 规则 - 熔断降级</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002238.png" srcset="/img/loading.gif" lazyload alt="|900|1000"><br>熔断降级作为保护自身的手段，通常<font color="#ff0000">在客户端（调用段）进行配置</font>。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002239.png" srcset="/img/loading.gif" lazyload alt="|575|1000"><br>当配置了熔断策略时，不发送请求给 B，直接执行 fallbak。</p>
<h4 id="3-6-1-工作原理"><a href="#3-6-1-工作原理" class="headerlink" title="3.6.1 工作原理"></a>3.6.1 工作原理</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002240.png" srcset="/img/loading.gif" lazyload alt="|875|1000"></p>
<ul>
<li>慢调用比例<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002241.png" srcset="/img/loading.gif" lazyload alt="|630|1000"><br>选择以慢调用比例作为阈值，需要设置允许的 慢调用 RT(即最大的响应时间)，请求的响应时间大于该值则统计为慢调用<br>当单位统计时长(5000ms)内请求数目大于设置的最小请求数目，并且慢调用（大于最大 RT）的比例大于阈值，则接下来的熔断时长内请求会自动被熔断<br>熔断时长后, 熔断器会进入探测恢复状态(HALF-OPEN 状态)，若接下来的一个请求响 应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断</li>
<li>异常比例<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002242.png" srcset="/img/loading.gif" lazyload alt="|655|1000"><br>当单位统计时长(statIntervalMs)内请求数目大于设置的最 小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断<br>经过熔断时长后熔断器会进入探测恢复状态(HALF-OPEN 状态)<br>若接下来的一个请求成功完成(没有错误)则结束熔断 否则会再次被熔断<br>异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%</li>
<li>异常数<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002243.png" srcset="/img/loading.gif" lazyload alt="|655|1000"><br>当单位统计时长内的异常数目超过阈值之后会自动进行熔断<br>经过熔断时长后熔断器会进入探测恢复状态(HALF-OPEN 状态)，若接下来的一个请求成功完成(没有错误)则结束熔断，否则会再次被熔断。</li>
</ul>
<h3 id="3-7-规则-热点参数"><a href="#3-7-规则-热点参数" class="headerlink" title="3.7 规则 - 热点参数"></a>3.7 规则 - 热点参数</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002244.png" srcset="/img/loading.gif" lazyload alt="|825|1000"><br>需求 1：每个用户秒杀 QPs 不得超过 1（秒杀下单 userld 级别）<br>需求 2：6 号用户是 vvip，不限制 QPS（例外情况）<br>需求 3：666 号是下架商品，不允许访问</p>
<ul>
<li>先设置好秒杀限流的兜底数据：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/secKill&quot;)</span>  <br><span class="hljs-meta">@SentinelResource(value = &quot;secKill-order&quot;, blockHandler = &quot;secKillFallback&quot;)</span><span class="hljs-comment">//设置秒杀订单限流  </span><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">secKill</span><span class="hljs-params">(<span class="hljs-meta">@PathParam(&quot;userId&quot;)</span> Long userId,  </span><br><span class="hljs-params">                     <span class="hljs-meta">@PathParam(&quot;productId&quot;)</span> Long productId)</span> &#123;  <br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(userId, productId);  <br>    order.setId(Long.MAX_VALUE);  <br>    <span class="hljs-keyword">return</span> order;  <br>&#125;  <br>  <br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">secKillFallback</span><span class="hljs-params">(Long userId, Long productId, BlockException e)</span> &#123;  <br>    System.out.println(<span class="hljs-string">&quot;秒杀失败，请稍后再试&quot;</span>);  <br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();  <br>    order.setId(productId);  <br>    order.setUserId(userId);  <br>    order.setAddress(<span class="hljs-string">&quot;Error&quot;</span>);  <br>    <span class="hljs-keyword">return</span> order;  <br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>blockHandler &#x3D; “secKillFallback” 只能处理 BlockException，使用 blockHandler-&gt;fallback,BlockException-&gt;Throwable, 可以处理业务异常，例如 public Order secKill(){}出现 1&#x2F;0 的异常。</p>
</blockquote>
<ul>
<li>设置热点规则<br>限制 userId 每秒只能有一个请求<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002245.png" srcset="/img/loading.gif" lazyload alt="|503|1000"></li>
<li>设置特殊 userId 允许每秒多个请求<br>边界页面使用高级设置<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002246.png" srcset="/img/loading.gif" lazyload alt="|530|1000"> </li>
<li>特殊商品禁止访问<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002247.png" srcset="/img/loading.gif" lazyload alt="|530|1000"><br>添加热点规则后再使用高级选项编辑。</li>
</ul>
<h2 id="4-Gateway-⽹关"><a href="#4-Gateway-⽹关" class="headerlink" title="4 Gateway - ⽹关"></a>4 Gateway - ⽹关</h2><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-gateway">https://spring.io/projects/spring-cloud-gateway</a></p>
<h3 id="4-1-基础⼊⻔"><a href="#4-1-基础⼊⻔" class="headerlink" title="4.1 基础⼊⻔"></a>4.1 基础⼊⻔</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002248.png" srcset="/img/loading.gif" lazyload alt="|750|1000"></p>
<h4 id="4-1-1-基本使用"><a href="#4-1-1-基本使用" class="headerlink" title="4.1.1 基本使用"></a>4.1.1 基本使用</h4><pre><code class="hljs">/api/order/**路由给订单
/api/product/**路由给商品
测试负载均衡
</code></pre>
<ul>
<li>新建 gateway module</li>
<li>引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>修改配置<br><code>gateway/src/main/resources/application.yaml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">application:</span>  <br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span>  <br>  <span class="hljs-attr">cloud:</span>  <br>    <span class="hljs-attr">nacos:</span>  <br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>  <br>  <br><span class="hljs-attr">server:</span>  <br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>
<ul>
<li>启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span>  <br><span class="hljs-meta">@SpringBootApplication</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GateWayApplication</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        SpringApplication.run(GateWayApplication.class, args);  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p> 为 service-order、service-prduct 添加 &#x2F;api 基础路径</p>
</blockquote>
<ul>
<li>修改 <code>application. yml</code> 配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">profiles:</span>  <br>    <span class="hljs-attr">include:</span> <span class="hljs-string">route</span><br></code></pre></td></tr></table></figure>
<ul>
<li>创建 <code>application-route.yaml</code> 配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">cloud:</span>  <br>    <span class="hljs-attr">gateway:</span>  <br>      <span class="hljs-attr">routes:</span>  <br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order</span>  <br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-order</span>  <br>          <span class="hljs-attr">predicates:</span>  <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/order/**</span>  <span class="hljs-comment"># 这样开头的路由都会被转发到service-order  </span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">product</span>  <br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-product</span>  <br>          <span class="hljs-attr">predicates:</span>  <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/product/**</span><br></code></pre></td></tr></table></figure>
<h4 id="4-1-2-原理"><a href="#4-1-2-原理" class="headerlink" title="4.1.2 原理"></a>4.1.2 原理</h4><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002249.png" srcset="/img/loading.gif" lazyload alt="|775|1000"></p>
<h3 id="4-2-Predicate-断⾔"><a href="#4-2-Predicate-断⾔" class="headerlink" title="4.2 Predicate - 断⾔"></a>4.2 Predicate - 断⾔</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> <br>	<span class="hljs-attr">cloud:</span> <br>		<span class="hljs-attr">gateway:</span> <br>			<span class="hljs-attr">routes:</span> <br>				<span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">after_route</span> <br>					<span class="hljs-attr">uri:</span> <span class="hljs-string">https://example.org</span> <br>					<span class="hljs-attr">predicates:</span> <br>					<span class="hljs-bullet">-</span> <span class="hljs-string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span><br></code></pre></td></tr></table></figure>
<p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002250.png" srcset="/img/loading.gif" lazyload alt="|650|1000"><br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002251.png" srcset="/img/loading.gif" lazyload alt="|650|1000"></p>
<h4 id="4-2-1-自定义路由断言工厂"><a href="#4-2-1-自定义路由断言工厂" class="headerlink" title="4.2.1 自定义路由断言工厂"></a>4.2.1 自定义路由断言工厂</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml">      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">bing-route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">https://cn.bing.com/</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Path</span><br>              <span class="hljs-attr">args:</span><br>                <span class="hljs-attr">patterns:</span> <span class="hljs-string">/search</span><br><span class="hljs-comment">#            - Vip=user,leifengyang</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Vip</span><br>              <span class="hljs-attr">args:</span><br>                <span class="hljs-attr">param:</span> <span class="hljs-string">user</span> <span class="hljs-comment"># 下面一一对应</span><br>                <span class="hljs-attr">value:</span> <span class="hljs-string">leifengyang</span><br></code></pre></td></tr></table></figure>

<p>工厂类 <code>VIP</code> 必须与配置类中对应，两个参数会在 <code>Config</code> 类中顺序对应，随后写断言逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VIPRoutePredicateFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRoutePredicateFactory</span>&lt;VIPRoutePredicateFactory.Config&gt; &#123;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VIPRoutePredicateFactory</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-built_in">super</span>(Config.class);  <br>    &#125;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(Config config)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayPredicate</span>() &#123;  <br>            <span class="hljs-meta">@Override</span>  <br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">test</span><span class="hljs-params">(ServerWebExchange serverWebExchange)</span> &#123;  <br>                <span class="hljs-comment">// localhost/search?q=haha&amp;user=leifengyang  </span><br>                <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> serverWebExchange.getRequest();  <br>  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> request.getQueryParams().getFirst(config.param);  <br>  <br>                <span class="hljs-keyword">return</span> StringUtils.hasText(first) &amp;&amp; first.equals(config.value);  <br>            &#125;        &#125;;    &#125;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">shortcutFieldOrder</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> Arrays.asList(<span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);  <br>    &#125;  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 可以配置的参数  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-meta">@Validated</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;  <br>  <br>        <span class="hljs-meta">@NotEmpty</span>  <br>        <span class="hljs-keyword">private</span> String param;  <br>  <br>  <br>        <span class="hljs-meta">@NotEmpty</span>  <br>        <span class="hljs-keyword">private</span> String value;  <br>  <br>        <span class="hljs-keyword">public</span> <span class="hljs-meta">@NotEmpty</span> String <span class="hljs-title function_">getParam</span><span class="hljs-params">()</span> &#123;  <br>            <span class="hljs-keyword">return</span> param;  <br>        &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParam</span><span class="hljs-params">(<span class="hljs-meta">@NotEmpty</span> String param)</span> &#123;  <br>            <span class="hljs-built_in">this</span>.param = param;  <br>        &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-meta">@NotEmpty</span> String <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;  <br>            <span class="hljs-keyword">return</span> value;  <br>        &#125;  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(<span class="hljs-meta">@NotEmpty</span> String value)</span> &#123;  <br>            <span class="hljs-built_in">this</span>.value = value;  <br>        &#125;    &#125;&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-3-Filter-过滤器"><a href="#4-3-Filter-过滤器" class="headerlink" title="4.3 Filter - 过滤器"></a>4.3 Filter - 过滤器</h3><h4 id="4-3-1-路径重写"><a href="#4-3-1-路径重写" class="headerlink" title="4.3.1 路径重写"></a>4.3.1 路径重写</h4><p>每个微服务都添加基准路径太麻烦。<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002252.png" srcset="/img/loading.gif" lazyload alt="|761|1000"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order</span>  <br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-order</span>  <br>  <span class="hljs-attr">predicates:</span>  <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/order/**</span>  <span class="hljs-comment"># 这样开头的路由都会被转发到service-order  </span><br>  <span class="hljs-attr">filters:</span>  <br>    <span class="hljs-comment"># 请求路径 /api/order/xxx 被正确重写为 /xxx，  </span><br>    <span class="hljs-comment"># 并将后续路径通过命名组 $&#123;segment&#125; 提取并传递给目标服务  </span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">RewritePath=/api/order/(?&lt;segment&gt;.*),</span> <span class="hljs-string">/$&#123;segment&#125;</span><br></code></pre></td></tr></table></figure>
<h4 id="4-3-2-默认-filter"><a href="#4-3-2-默认-filter" class="headerlink" title="4.3.2 默认 filter"></a>4.3.2 默认 filter</h4><p>所有路由添加默认返回头。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">default-filters:</span>  <br>  <span class="hljs-bullet">-</span> <span class="hljs-string">AddResponseHeader=X-Response-Abc,</span> <span class="hljs-number">123</span><br></code></pre></td></tr></table></figure>
<h4 id="4-3-3-全局-filter"><a href="#4-3-3-全局-filter" class="headerlink" title="4.3.3 全局 filter"></a>4.3.3 全局 filter</h4><p>设置每个请求记录相应时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>  <br><span class="hljs-meta">@Slf4j</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RtGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;  <br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();  <br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();  <br>  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getURI().toString();  <br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();  <br>        log.info(<span class="hljs-string">&quot;请求【&#123;&#125;】开始：时间：&#123;&#125;&quot;</span>,uri,start);  <br>        <span class="hljs-comment">//========================以上是前置逻辑=========================  </span><br>        Mono&lt;Void&gt; filter = chain.filter(exchange)  <br>                .doFinally((result)-&gt;&#123;  <br>                    <span class="hljs-comment">//=======================以下是后置逻辑=========================  </span><br>                    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();  <br>                    log.info(<span class="hljs-string">&quot;请求【&#123;&#125;】结束：时间：&#123;&#125;，耗时：&#123;&#125;ms&quot;</span>,uri,end,end-start);  <br>                &#125;); <span class="hljs-comment">//放行   10s        return filter;  </span><br>    &#125;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-3-4-自定义过滤器工程"><a href="#4-3-4-自定义过滤器工程" class="headerlink" title="4.3.4 自定义过滤器工程"></a>4.3.4 自定义过滤器工程</h4><p>每个请求发出后添加一个自定义的响应头（一次性令牌），但是只希望在订单下使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnceTokenGatewayFilterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractNameValueGatewayFilterFactory</span> &#123;  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> GatewayFilter <span class="hljs-title function_">apply</span><span class="hljs-params">(NameValueConfig config)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayFilter</span>() &#123;  <br>            <span class="hljs-meta">@Override</span>  <br>            <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;  <br>                <span class="hljs-comment">//每次响应之前，添加一个一次性令牌，支持 uuid，jwt等各种格式  </span><br>                <span class="hljs-keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(()-&gt;&#123;  <br>                    <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();  <br>                    <span class="hljs-type">HttpHeaders</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> response.getHeaders();  <br>                    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> config.getValue();  <br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;uuid&quot;</span>.equalsIgnoreCase(value))&#123;  <br>                        value = UUID.randomUUID().toString();  <br>                    &#125;  <br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;jwt&quot;</span>.equalsIgnoreCase(value))&#123;  <br>                        value = <span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ&quot;</span>;  <br>                    &#125;  <br>                    headers.add(config.getName(),value);  <br>                &#125;));            &#125;        &#125;;    &#125;&#125;<br></code></pre></td></tr></table></figure>

<p>和自定义路由断言工厂类似, 在配置文件添加对应配置，注意头【OnceToken】要相同。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">filters:</span>  <br>   <span class="hljs-string">...</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">OnceToken=X-Response-Token,uuid</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-CORS-跨域处理"><a href="#4-4-CORS-跨域处理" class="headerlink" title="4.4 CORS - 跨域处理"></a>4.4 CORS - 跨域处理</h3><p>全局跨域</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">cloud:</span>  <br>    <span class="hljs-attr">gateway:</span>  <br>      <span class="hljs-attr">globalcors:</span>  <br>        <span class="hljs-attr">cors-configurations:</span>  <br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span>  <br>            <span class="hljs-attr">allowed-origin-patterns:</span>  <br>              <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;*&quot;</span>  <br>            <span class="hljs-attr">allowed-headers:</span>  <br>              <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;*&quot;</span>  <br>            <span class="hljs-attr">allowed-methods:</span>  <br>              <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="4-5-面试题"><a href="#4-5-面试题" class="headerlink" title="4.5 面试题"></a>4.5 面试题</h3><p>微服务之间的调用经过网关吗？<br>网关主要用于处理外部请求，作为系统的统一入口，微服务之间使用服务注册与发现机制进行内部通信，所以<font color="#ff0000">微服务之间的调用通常不经过网关</font>。但是通过配置 FeignClient 或 RestTemplate 指定走网关地址（如 <a target="_blank" rel="noopener" href="http://gateway-host/api/product/xxx">http://gateway-host/api/product/xxx</a> ），即先跳转到网关，再转发到对应微服务（不建议）。</p>
<h2 id="5-Seata-分布式事务"><a href="#5-Seata-分布式事务" class="headerlink" title="5 Seata-分布式事务"></a>5 Seata-分布式事务</h2><p><a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/">https://seata.apache.org/zh-cn/</a><br><a target="_blank" rel="noopener" href="http://localhost:7091/">http://localhost:7091</a> 打开客户端，用户名和密码都是 seata。<br>每个微服务配置 <code>file.conf</code>     <code>services/seata-account/src/main/resources/file.conf</code></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs txt">service &#123;  <br>  #transaction service group mapping  <br>  vgroupMapping.default_tx_group = &quot;default&quot;  <br>  #only support when registry.type=file, please don&#x27;t set multiple addresses  <br>  default.grouplist = &quot;127.0.0.1:8091&quot;  <br>  #degrade, current not support  <br>  enableDegrade = false  <br>  #disable seata  <br>  disableGlobalTransaction = false  <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="5-1-环境准备"><a href="#5-1-环境准备" class="headerlink" title="5.1 环境准备"></a>5.1 环境准备</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002253.png" srcset="/img/loading.gif" lazyload alt="|575|1000"><br>导入课程中的四个包…</p>
<ul>
<li>导入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span> <br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span> <br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<ul>
<li>下载并启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">seata-server.bat<br></code></pre></td></tr></table></figure>
<h4 id="5-1-1-业务流程"><a href="#5-1-1-业务流程" class="headerlink" title="5.1.1 业务流程"></a>5.1.1 业务流程</h4><p>进行采购需要远程调用扣减库存和创建订单，创建订单又需要远程调用减余额。</p>
<ul>
<li>进行采购</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusinessService</span> &#123;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    StorageFeignClient storageFeignClient;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    OrderFeignClient orderFeignClient;  <br>    <span class="hljs-meta">@GlobalTransactional</span>  <br>    <span class="hljs-meta">@Override</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">purchase</span><span class="hljs-params">(String userId, String commodityCode, <span class="hljs-type">int</span> orderCount)</span> &#123;  <br>        <span class="hljs-comment">//1. 扣减库存  </span><br>        storageFeignClient.deduct(commodityCode, orderCount);  <br>  <br>        <span class="hljs-comment">//2. 创建订单  </span><br>        orderFeignClient.create(userId, commodityCode, orderCount);  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>创建订单对应的 <code>OrderFeignClient</code>，发起远程调用-创建订单</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;seata-order&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderFeignClient</span> &#123;  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 创建订单  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> commodityCode  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderCount  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-meta">@GetMapping(&quot;/create&quot;)</span>  <br>    String <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;userId&quot;)</span> String userId,  </span><br><span class="hljs-params">                         <span class="hljs-meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,  </span><br><span class="hljs-params">                         <span class="hljs-meta">@RequestParam(&quot;count&quot;)</span> <span class="hljs-type">int</span> orderCount)</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>创建订单</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/create&quot;)</span>  <br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;userId&quot;)</span> String userId,  </span><br><span class="hljs-params">                     <span class="hljs-meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,  </span><br><span class="hljs-params">                     <span class="hljs-meta">@RequestParam(&quot;count&quot;)</span> <span class="hljs-type">int</span> orderCount)</span>  <br>&#123;  <br>    <span class="hljs-type">OrderTbl</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> orderService.create(userId, commodityCode, orderCount);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order create success = 订单id：【&quot;</span>+tbl.getId()+<span class="hljs-string">&quot;】&quot;</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>在创建订单的实现类中又会发起扣减余额的远程调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    OrderTblMapper orderTblMapper;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    AccountFeignClient accountFeignClient;  <br>    <span class="hljs-meta">@Transactional</span>  <br>    <span class="hljs-meta">@Override</span>    <span class="hljs-keyword">public</span> OrderTbl <span class="hljs-title function_">create</span><span class="hljs-params">(String userId, String commodityCode, <span class="hljs-type">int</span> orderCount)</span> &#123;  <br>        <span class="hljs-comment">//1、计算订单价格  </span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">orderMoney</span> <span class="hljs-operator">=</span> calculate(commodityCode, orderCount);  <br>        <span class="hljs-comment">//2、扣减账户余额  </span><br>        accountFeignClient.debit(userId, orderMoney);  <br>        <span class="hljs-comment">//3、保存订单  </span><br>        <span class="hljs-type">OrderTbl</span> <span class="hljs-variable">orderTbl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderTbl</span>();  <br>        orderTbl.setUserId(userId);  <br>        orderTbl.setCommodityCode(commodityCode);  <br>        orderTbl.setCount(orderCount);  <br>        orderTbl.setMoney(orderMoney);  <br>        <span class="hljs-comment">//3、保存订单  </span><br>        orderTblMapper.insert(orderTbl);  <br>        <span class="hljs-keyword">return</span> orderTbl;  <br>    &#125;  <br>    <span class="hljs-comment">// 计算价格  </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(String commodityCode, <span class="hljs-type">int</span> orderCount)</span> &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-number">9</span>*orderCount;  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>
<p>扣减余额的 Feign 客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;seata-account&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountFeignClient</span> &#123;  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment">     * 扣减账户余额  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  </span><br><span class="hljs-comment">     */</span>  <br>    <span class="hljs-meta">@GetMapping(&quot;/debit&quot;)</span>  <br>    String <span class="hljs-title function_">debit</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;userId&quot;)</span> String userId,  </span><br><span class="hljs-params">                        <span class="hljs-meta">@RequestParam(&quot;money&quot;)</span> <span class="hljs-type">int</span> money)</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="5-2-分布式服务"><a href="#5-2-分布式服务" class="headerlink" title="5.2 分布式服务"></a>5.2 分布式服务</h3><p><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002254.png" srcset="/img/loading.gif" lazyload alt="|1125|1000"><br>只需要在主要的事务入口配置<font color="#ff0000">全局事务</font> <code>@GlobalTransactional</code>，就能控制全局事务，实现事务回滚。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusinessService</span> &#123;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    StorageFeignClient storageFeignClient;  <br>    <span class="hljs-meta">@Autowired</span>  <br>    OrderFeignClient orderFeignClient;  <br>  <br>    <span class="hljs-meta">@GlobalTransactional</span>  <br>    <span class="hljs-meta">@Override</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">purchase</span><span class="hljs-params">(String userId, String commodityCode, <span class="hljs-type">int</span> orderCount)</span> &#123;  <br>        <span class="hljs-comment">//1. 扣减库存  </span><br>        storageFeignClient.deduct(commodityCode, orderCount);  <br>  <br>        <span class="hljs-comment">//2. 创建订单  </span><br>        orderFeignClient.create(userId, commodityCode, orderCount);  <br>    &#125;&#125;<br></code></pre></td></tr></table></figure>

<p>全局事务流程-<font color="#ff0000">二阶提交协议流程</font><br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002255.png" srcset="/img/loading.gif" lazyload alt="|1000"><br>注意以下几个要点<br><img src="https://note-image-shi.oss-cn-beijing.aliyuncs.com/images/202507012002256.png" srcset="/img/loading.gif" lazyload alt="|875|1000"></p>
<h3 id="5-3-Seata的四种事务模式"><a href="#5-3-Seata的四种事务模式" class="headerlink" title="5.3 Seata的四种事务模式"></a>5.3 Seata的四种事务模式</h3><p>AT、TCC、SAGA、XA</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h2><p>自己绘制总结图…</p>
<p align="right">2025.06.22 结束</p>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java%E5%BC%80%E5%8F%91/" class="category-chain-item">Java开发</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/SpringCloud/" class="print-no-link">#SpringCloud</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>尚硅谷七小时学完SpringCloud</div>
      <div>http://example.com/2025/07/31/00.我的笔记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Solar</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 31, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/30/%E5%93%88%E5%B8%8C%E8%A1%A8/" title="哈希表">
                        <span class="hidden-mobile">哈希表</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/scrollAnimation.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
